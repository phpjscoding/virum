{% comment %}
  Collection Page Template â€” Shopify Liquid
  Schema: collection template with filters, sort, and pagination
{% endcomment %}

{% schema %}
{
  "name": "Collection Page",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 4,
      "max": 24,
      "step": 4,
      "default": 8,
      "label": "Products per page"
    },
    {
      "type": "select",
      "id": "default_columns",
      "label": "Default grid columns",
      "options": [
        { "value": "2", "label": "2 columns" },
        { "value": "3", "label": "3 columns" },
        { "value": "4", "label": "4 columns" }
      ],
      "default": "3"
    },
    {
      "type": "header",
      "content": "Filters"
    },
    {
      "type": "checkbox",
      "id": "show_filters",
      "label": "Show sidebar filters",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_price_filter",
      "label": "Enable price range filter",
      "default": true
    },
    {
      "type": "number",
      "id": "price_filter_max",
      "label": "Max price filter value",
      "default": 200
    },
    {
      "type": "header",
      "content": "Sort"
    },
    {
      "type": "checkbox",
      "id": "show_sort",
      "label": "Show sort options",
      "default": true
    },
    {
      "type": "header",
      "content": "Product Card"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show product vendor",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_quick_look",
      "label": "Show Quick Look button",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_add_to_cart",
      "label": "Show Add to Cart on hover",
      "default": true
    }
  ],
  "blocks": [],
  "presets": [
    {
      "name": "Collection Page",
      "category": "Collection"
    }
  ]
}
{% endschema %}

{% paginate collection.products by section.settings.products_per_page %}
  <div class="max-w-7xl mx-auto px-4 md:px-8 py-16">
    <div class="flex flex-col lg:flex-row gap-16">
      {%- if section.settings.show_filters -%}
        <!-- ===================== SIDEBAR FILTERS ===================== -->
        <aside class="hidden lg:block w-64 flex-shrink-0 space-y-12">
          <div>
            <div class="flex items-center justify-between mb-8">
              <h3 class="text-xs font-bold tracking-widest uppercase text-zinc-900">Filters</h3>
            </div>

            <!-- Product Type Filter -->
            <div class="mb-10">
              <h4 class="text-[10px] font-bold tracking-[0.2em] uppercase text-zinc-400 mb-6">Product Type</h4>
              <div class="space-y-3">
                {%- assign product_types = collection.all_types -%}
                {%- for type in product_types -%}
                  {%- if type != blank -%}
                    {%- assign type_active = false -%}
                    {%- if current_tags contains type -%}
                      {%- assign type_active = true -%}
                    {%- endif -%}
                    <label class="flex items-center group cursor-pointer" aria-label="Filter by {{ type }}">
                      <input
                        class="hidden filter-checkbox"
                        type="checkbox"
                        name="type"
                        value="{{ type | handle }}"
                        data-filter-type="type"
                        {% if type_active %}
                          checked
                        {% endif %}
                        aria-checked="{{ type_active }}"
                      >
                      <div class="w-4 h-4 border border-zinc-200 mr-3 flex items-center justify-center transition-all group-hover:border-zinc-900 {% if type_active %}!border-zinc-900 bg-zinc-900{% endif %}">
                        {% if type_active %}
                          <svg
                            width="10"
                            height="10"
                            viewBox="0 0 10 10"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                          >
                            <path d="M1.5 5L4 7.5L8.5 2.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        {% endif %}
                      </div>
                      <span class="text-sm transition-colors {% if type_active %}text-zinc-900 font-medium{% else %}text-zinc-500 hover:text-zinc-900{% endif %}">
                        {{ type }}
                      </span>
                    </label>
                  {%- endif -%}
                {%- else -%}
                  <!-- Fallback static types if collection has none -->
                  {%- assign static_types = 'Wine Glasses,Tumblers,Champagne Flutes,Pitchers,Decanters,Vases'
                    | split: ','
                  -%}
                  {%- for static_type in static_types -%}
                    <label class="flex items-center group cursor-pointer">
                      <input class="hidden" type="checkbox">
                      <div
                        class="w-4 h-4 border border-zinc-200 mr-3 flex items-center justify-center transition-all group-hover:border-zinc-900"
                      ></div>
                      <span class="text-sm transition-colors text-zinc-500 hover:text-zinc-900">{{ static_type }}</span>
                    </label>
                  {%- endfor -%}
                {%- endfor -%}
              </div>
            </div>

            <!-- Vendor / Material Filter (mapped from vendors) -->
            <div class="mb-10">
              <h4 class="text-[10px] font-bold tracking-[0.2em] uppercase text-zinc-400 mb-6">Material</h4>
              <div class="space-y-3">
                {%- assign all_vendors = collection.all_vendors -%}
                {%- for vendor in all_vendors -%}
                  {%- if vendor != blank -%}
                    {%- assign vendor_active = false -%}
                    {%- if current_tags contains vendor -%}
                      {%- assign vendor_active = true -%}
                    {%- endif -%}
                    <label class="flex items-center group cursor-pointer">
                      <input
                        class="hidden filter-checkbox"
                        type="checkbox"
                        name="vendor"
                        value="{{ vendor | handle }}"
                        data-filter-type="vendor"
                        {% if vendor_active %}
                          checked
                        {% endif %}
                      >
                      <div class="w-4 h-4 border border-zinc-200 mr-3 flex items-center justify-center transition-all group-hover:border-zinc-900 {% if vendor_active %}!border-zinc-900 bg-zinc-900{% endif %}">
                        {% if vendor_active %}
                          <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                            <path d="M1.5 5L4 7.5L8.5 2.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        {% endif %}
                      </div>
                      <span class="text-sm transition-colors {% if vendor_active %}text-zinc-900 font-medium{% else %}text-zinc-500 hover:text-zinc-900{% endif %}">
                        {{ vendor }}
                      </span>
                    </label>
                  {%- endif -%}
                {%- else -%}
                  <!-- Static fallback materials -->
                  {%- assign static_materials = 'Crystal,Borosilicate,Glass' | split: ',' -%}
                  {%- for material in static_materials -%}
                    <label class="flex items-center group cursor-pointer">
                      <input class="hidden" type="checkbox">
                      <div
                        class="w-4 h-4 border border-zinc-200 mr-3 flex items-center justify-center transition-all group-hover:border-zinc-900"
                      ></div>
                      <span class="text-sm transition-colors text-zinc-500 hover:text-zinc-900">{{ material }}</span>
                    </label>
                  {%- endfor -%}
                {%- endfor -%}
              </div>
            </div>

            <!-- Price Range Filter -->
            {%- if section.settings.enable_price_filter -%}
              <div>
                <h4 class="text-[10px] font-bold tracking-[0.2em] uppercase text-zinc-400 mb-6">Price Range</h4>
                <input
                  id="price-range-filter"
                  {% comment %} min="{{ collection.products_count > 0 | ternary: collection.products.first.price | divided_by: 100 | floor, 0 }}" {% endcomment %}
                  min="{{ collection.products | map: 'price' | sort | first | divided_by: 100 | floor | default: 0 }}"
                  max="{{ section.settings.price_filter_max }}"
                  class="w-full accent-zinc-900 h-1 bg-zinc-100 rounded-lg cursor-pointer"
                  type="range"
                  value="{{ section.settings.price_filter_max }}"
                >
                <div class="flex justify-between mt-4 text-[10px] font-bold text-zinc-400">
                  <span>$0</span>
                  <span id="price-range-label">Up to ${{ section.settings.price_filter_max }}</span>
                </div>
              </div>
            {%- endif -%}
          </div>
        </aside>
      {%- endif -%}

      <!-- ===================== MAIN CONTENT ===================== -->
      <div class="flex-1">
        <!-- Toolbar: count + mobile filter trigger + sort -->
        <div class="flex flex-col sm:flex-row sm:items-center justify-between border-b border-zinc-100 pb-8 mb-12 gap-6">
          <div class="text-[10px] font-bold tracking-widest uppercase text-zinc-400">
            Showing
            <span class="text-zinc-900">{{ paginate.items }}</span>
            {%- if paginate.pages > 1 -%}
              &nbsp;&mdash;&nbsp;Page
              <span class="text-zinc-900">{{ paginate.current_page }}</span>
              of
              <span class="text-zinc-900">{{ paginate.pages }}</span>
            {%- endif -%}
            Products
          </div>

          <div class="flex items-center gap-8">
            <!-- Mobile filter toggle -->
            {%- if section.settings.show_filters -%}
              <div class="flex items-center gap-2 lg:hidden">
                <button
                  id="mobile-filter-btn"
                  class="flex items-center gap-2 text-[10px] font-bold tracking-widest uppercase border border-zinc-200 px-4 py-2 hover:border-zinc-900 transition-all"
                  aria-controls="mobile-filter-drawer"
                  aria-expanded="false"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    aria-hidden="true"
                  >
                    <path d="M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z"/>
                  </svg>
                  Filters
                </button>
              </div>
            {%- endif -%}

            <!-- Sort dropdown -->
            {%- if section.settings.show_sort -%}
              <div class="relative group" role="navigation" aria-label="Sort products">
                <div class="flex items-center gap-2 text-[10px] font-bold tracking-widest uppercase cursor-pointer border-b border-transparent hover:border-zinc-900 pb-1">
                  Sort By:
                  <span class="text-zinc-900" id="sort-label">
                    {%- case collection.sort_by -%}
                      {%- when 'price-ascending' -%}
                        Price: Low to High
                      {%- when 'price-descending' -%}
                        Price: High to Low
                      {%- when 'created-descending' -%}
                        Newest
                      {%- when 'best-selling' -%}
                        Best Selling
                      {%- else -%}
                        Featured
                    {%- endcase -%}
                  </span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    aria-hidden="true"
                  >
                    <path d="m6 9 6 6 6-6"/>
                  </svg>
                </div>
                <div
                  class="absolute top-full right-0 mt-2 w-48 bg-white shadow-xl p-4 flex flex-col gap-3 z-20 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all border border-zinc-100"
                  role="list"
                >
                  {%- assign sort_options = 'manual:Featured,created-descending:Newest,price-ascending:Price: Low to High,price-descending:Price: High to Low,best-selling:Best Selling'
                    | split: ','
                  -%}
                  {%- for option_raw in sort_options -%}
                    {%- assign option_parts = option_raw | split: ':' -%}
                    {%- assign option_value = option_parts[0] -%}
                    {%- assign option_label = option_parts[1] | append: option_parts[2] -%}
                    <a
                      href="{{ collection.url }}?sort_by={{ option_value }}"
                      role="listitem"
                      class="text-left text-[10px] font-bold tracking-widest uppercase hover:text-zinc-400 {% if collection.sort_by == option_value %}text-zinc-900 underline{% endif %}"
                      aria-current="{% if collection.sort_by == option_value %}true{% else %}false{% endif %}"
                    >
                      {{ option_label }}
                    </a>
                  {%- endfor -%}
                </div>
              </div>
            {%- endif -%}
          </div>
        </div>

        <!-- ===================== PRODUCT GRID ===================== -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-{{ section.settings.default_columns }} gap-x-8 gap-y-16">
          {%- for product in collection.products -%}
            {%- assign badge_label = '' -%}
            {%- assign badge_style = '' -%}

            {%- if product.tags contains 'sale' or product.compare_at_price > product.price -%}
              {%- assign badge_label = 'Sale' -%}
              {%- assign badge_style = 'bg-zinc-900 text-white' -%}

            {%- elsif product.tags contains 'new' -%}
              {%- assign badge_label = 'New' -%}
              {%- assign badge_style = 'bg-white text-zinc-900' -%}
            {%- endif -%}

            <div class="group cursor-pointer" itemscope itemtype="https://schema.org/Product">
              <meta itemprop="name" content="{{ product.title | escape }}">
              <meta itemprop="sku" content="{{ product.variants.first.sku | escape }}">
              <meta itemprop="url" content="{{ shop.url }}{{ product.url }}">

              <a href="{{ product.url }}" aria-label="{{ product.title | escape }}" class="block">
                <!-- Product Image -->
                <div class="relative aspect-[3/4] overflow-hidden bg-zinc-50 mb-6">
                  {%- if product.featured_image -%}
                    <img
                      alt="{{ product.featured_image.alt | default: product.title | escape }}"
                      class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                      src="{{ product.featured_image | image_url: width: 800 }}"
                      srcset="
                        {{ product.featured_image | image_url: width: 400 }} 400w,
                        {{ product.featured_image | image_url: width: 800 }} 800w,
                        {{ product.featured_image | image_url: width: 1200 }} 1200w
                      "
                      sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
                      loading="lazy"
                      width="800"
                      height="{{ 800 | divided_by: product.featured_image.aspect_ratio | ceil }}"
                      itemprop="image"
                    >
                  {%- else -%}
                    {{
                      'product-1'
                      | placeholder_svg_tag: 'w-full h-full object-cover transition-transform duration-700 group-hover:scale-105'
                    }}
                  {%- endif -%}

                  <!-- Badge -->
                  {%- if badge_label != '' -%}
                    <div class="absolute top-4 left-4 flex flex-col gap-2">
                      <span class="{{ badge_style }} px-3 py-1 text-[9px] font-bold tracking-widest uppercase shadow-sm">
                        {{ badge_label }}
                      </span>
                    </div>
                  {%- endif -%}

                  <!-- Hover overlay: Quick Look + Cart -->
                  <div class="absolute bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm p-4 translate-y-full group-hover:translate-y-0 transition-transform flex items-center justify-between">
                    {%- if section.settings.show_quick_look -%}
                      <button
                        class="text-[10px] font-bold tracking-widest uppercase flex items-center gap-2 hover:text-zinc-500"
                        data-quick-look="{{ product.handle }}"
                        aria-label="Quick look at {{ product.title | escape }}"
                        onclick="event.preventDefault();"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="14"
                          height="14"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          aria-hidden="true"
                        >
                          <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/>
                          <circle cx="12" cy="12" r="3"/>
                        </svg>
                        Quick Look
                      </button>
                    {%- endif -%}

                    {%- if section.settings.show_add_to_cart -%}
                      <button
                        class="p-2 hover:bg-zinc-900 hover:text-white transition-colors"
                        data-product-id="{{ product.variants.first.id }}"
                        aria-label="Add {{ product.title | escape }} to cart"
                        onclick="event.preventDefault(); addToCart({{ product.variants.first.id }});"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          aria-hidden="true"
                        >
                          <circle cx="8" cy="21" r="1"/>
                          <circle cx="19" cy="21" r="1"/>
                          <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
                        </svg>
                      </button>
                    {%- endif -%}
                  </div>
                </div>

                <!-- Product Info -->
                <div class="text-center" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
                  <meta itemprop="priceCurrency" content="{{ cart.currency.iso_code }}">
                  <meta
                    itemprop="availability"
                    content="https://schema.org/{% if product.available %}InStock{% else %}OutOfStock{% endif %}"
                  >
                  <link itemprop="url" href="{{ shop.url }}{{ product.url }}">

                  {%- if section.settings.show_vendor -%}
                    <p class="text-zinc-400 text-[10px] tracking-widest uppercase mb-1">
                      {{ product.vendor | escape }}
                    </p>
                  {%- endif -%}

                  <p class="text-zinc-400 text-[10px] tracking-widest uppercase mb-2">
                    {{ product.vendor | default: product.type | escape }}
                    {%- if product.type != blank -%}
                      &nbsp;&bull;&nbsp;{{ product.type | escape }}
                    {%- endif -%}
                  </p>

                  <h3 class="text-lg text-zinc-900 mb-2" itemprop="name">
                    {{ product.title | escape }}
                  </h3>

                  <p class="font-medium text-zinc-700 font-sans tracking-wide">
                    {%- if product.compare_at_price > product.price -%}
                      <span class="line-through text-zinc-400 mr-2">{{ product.compare_at_price | money }}</span>
                    {%- endif -%}
                    <span itemprop="price" content="{{ product.price | divided_by: 100.0 }}">
                      {{ product.price | money }}
                    </span>
                  </p>
                </div>
              </a>
            </div>
          {%- else -%}
            <!-- Empty state -->
            <div class="col-span-full text-center py-24">
              <p class="text-zinc-400 text-sm tracking-widest uppercase">No products found in this collection.</p>
              <a
                href="{{ routes.all_products_collection_url }}"
                class="inline-block mt-6 text-[10px] font-bold tracking-widest uppercase border border-zinc-900 px-6 py-3 hover:bg-zinc-900 hover:text-white transition-all"
              >
                Browse All Products
              </a>
            </div>
          {%- endfor -%}
        </div>

        <!-- ===================== PAGINATION ===================== -->
        {%- if paginate.pages > 1 -%}
          {% render page_numbers,paginate %}

          <!-- Accessible page summary for screen readers -->
          <p class="sr-only" aria-live="polite">Page {{ paginate.current_page }} of {{ paginate.pages }}</p>
        {%- endif -%}
      </div>
      <!-- end .flex-1 -->
    </div>
    <!-- end .flex -->
  </div>
  <!-- end .max-w-7xl -->
{% endpaginate %}

<!-- ===================== MOBILE FILTER DRAWER ===================== -->
{%- if section.settings.show_filters -%}
  <div
    id="mobile-filter-drawer"
    class="fixed inset-0 z-50 hidden"
    role="dialog"
    aria-modal="true"
    aria-label="Product filters"
  >
    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" id="filter-overlay"></div>
    <div class="absolute right-0 top-0 bottom-0 w-80 bg-white shadow-2xl p-8 overflow-y-auto">
      <div class="flex items-center justify-between mb-8">
        <h3 class="text-xs font-bold tracking-widest uppercase text-zinc-900">Filters</h3>
        <button id="close-filter-btn" aria-label="Close filters" class="p-2 hover:bg-zinc-100 transition-colors">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M18 6 6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <!-- Mirrors desktop sidebar content -->
      <p class="text-sm text-zinc-500">Use desktop filters above or browse full collection.</p>
    </div>
  </div>
{%- endif -%}

<!-- ===================== JAVASCRIPT ===================== -->
<script>
  /* --- Price range label --- */
  (function () {
    const range = document.getElementById('price-range-filter');
    const label = document.getElementById('price-range-label');
    if (!range || !label) return;
    range.addEventListener('input', function () {
      label.textContent = 'Up to $' + this.value;
    });
  })();

  /* --- Add to Cart via Shopify AJAX API --- */
  function addToCart(variantId) {
    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: variantId, quantity: 1 }),
    })
      .then(function (res) {
        return res.json();
      })
      .then(function (item) {
        // Dispatch event for cart drawer / mini-cart integrations
        document.dispatchEvent(new CustomEvent('cart:item-added', { detail: item }));
        // Refresh cart count badge if present
        const badge = document.querySelector('[data-cart-count]');
        if (badge) {
          fetch('/cart.js')
            .then(function (r) {
              return r.json();
            })
            .then(function (cart) {
              badge.textContent = cart.item_count;
            });
        }
      })
      .catch(function (err) {
        console.error('Cart error:', err);
      });
  }

  /* --- Mobile filter drawer --- */
  (function () {
    const btn = document.getElementById('mobile-filter-btn');
    const drawer = document.getElementById('mobile-filter-drawer');
    const close = document.getElementById('close-filter-btn');
    const overlay = document.getElementById('filter-overlay');
    if (!btn || !drawer) return;

    function openDrawer() {
      drawer.classList.remove('hidden');
      btn.setAttribute('aria-expanded', 'true');
      document.body.style.overflow = 'hidden';
    }
    function closeDrawer() {
      drawer.classList.add('hidden');
      btn.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
    }

    btn.addEventListener('click', openDrawer);
    if (close) close.addEventListener('click', closeDrawer);
    if (overlay) overlay.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') closeDrawer();
    });
  })();
</script>
